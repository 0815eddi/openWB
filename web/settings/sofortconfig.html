<!DOCTYPE html>
<html lang="de">

	<head>
		<base href="/openWB/web/">

		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>openWB Einstellungen</title>
		<meta name="description" content="Control your charge" />
		<meta name="author" content="Kevin Wieland, Michael Ortenstein" />
		<!-- Favicons (created with http://realfavicongenerator.net/)-->
		<link rel="apple-touch-icon" sizes="57x57" href="img/favicons/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="img/favicons/apple-touch-icon-60x60.png">
		<link rel="icon" type="image/png" href="img/favicons/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="img/favicons/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="manifest.json">
		<link rel="shortcut icon" href="img/favicons/favicon.ico">
		<meta name="msapplication-TileColor" content="#00a8ff">
		<meta name="msapplication-config" content="img/favicons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">

		<!-- Bootstrap -->
		<link rel="stylesheet" type="text/css" href="css/bootstrap-4.4.1/bootstrap.min.css">
		<!-- Normalize -->
		<link rel="stylesheet" type="text/css" href="css/normalize-8.0.1.css">
		<!-- include settings-style -->
		<link rel="stylesheet" type="text/css" href="settings/settings_style.css?ver=20200416-a">

		<!-- important scripts to be loaded -->
		<script src="js/jquery-3.4.1.min.js"></script>
		<script src="js/bootstrap-4.4.1/bootstrap.bundle.min.js"></script>
	</head>

	<body>

		<div id="nav"></div> <!-- placeholder for navbar -->

		<div role="main" class="container" style="margin-top:20px">

			<form id="myForm">
				<h1>Einstellungen für Sofortladen</h1>

				<div class="card">
					<div class="card-header font-weight-bold text-white bg-secondary">
	    				 Allgemeine Einstellungen
	  				</div>
					<div class="card-body">
						<h6 class="mb-0">Mindeststromstärke</h6>
						<div>
							<small>
								Paramter in Ampere [A] für den minimalen Strom im Modus Sofortladen.
								Definiert den minimalen Ladestrom an allen Ladepunkten. Einige EV benötigen einen Mindestladestrom, da ansonsten die Ladung nicht startet.
								Der kleinste einstellbare Wert liegt aus technischen Gründen bei 6 A.
							</small>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="minEVSECurrentAllowed" class="col-3 col-sm-2 col-form-label">alle LP:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="minEVSECurrentAllowed" min="6" max="16" step="1" value="" data-default="6" data-topicprefix="openWB/config/get/global/">
							</div>
							<label for="minEVSECurrentAllowed" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
					</div>  <!-- end card body Allgemeine Einstellungen Sofort -->
				</div>  <!-- end card Allgemeine Einstellungen Sofort -->

				<br>

				<div class="card">
					<div class="card-header font-weight-bold text-white bg-secondary">
	    				 Ladepunkt-Einstellungen
	  				</div>
					<div class="card-body">
						<h6 class="mb-0">Ladestrom</h6>
						<div>
							<small>
								Paramter in Ampere [A] für den Ladestrom im Modus Sofortladen.
								Definiert den Ladestrom am Ladepunkt. Der kleinste einstellbare Wert liegt aus technischen Gründen bei 6 A, der größte bei 32 A.
								Er kann nie kleiner sein als die eingestellte Mindeststromstärke an den Ladepunkten.
							</small>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp1" class="col-3 col-sm-2 col-form-label">LP1:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp1" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/1/">
							</div>
							<label for="currentlp1" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp2" class="col-3 col-sm-2 col-form-label">LP2:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp2" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/2/">
							</div>
							<label for="currentlp2" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp3" class="col-3 col-sm-2 col-form-label">LP3:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp3" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/3/">
							</div>
							<label for="currentlp3" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp4" class="col-3 col-sm-2 col-form-label">LP4:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp4" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/4/">
							</div>
							<label for="currentlp4" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp5" class="col-3 col-sm-2 col-form-label">LP5:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp5" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/5/">
							</div>
							<label for="currentlp5" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp6" class="col-3 col-sm-2 col-form-label">LP6:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp6" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/6/">
							</div>
							<label for="currentlp6" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp7" class="col-3 col-sm-2 col-form-label">LP7:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp7" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/7/">
							</div>
							<label for="currentlp7" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
						<div class="form-row form-group mb-0 vaRow">
							<label for="currentlp8" class="col-3 col-sm-2 col-form-label">LP8:</label>
							<div class="col-6 col-sm-4">
								<input type="range" class="form-control-range rangeInput" id="currentlp8" name="current" min="6" max="32" step="1" value="" data-default="16" data-topicprefix="openWB/config/get/sofort/" data-topicsubgroup="lp/8/">
							</div>
							<label for="currentlp8" class="col col-form-label valueLabel" suffix="A"></label>
						</div>
					</div>  <!-- end card body Allgemeine Einstellungen Sofort -->
				</div>  <!-- end card Allgemeine Einstellungen Sofort -->

				<br>

				<div class="row justify-content-center">
					<div class="col-3">
						<button id="saveSettingsBtn" type="button" class="btn btn-success">speichern</button>
					</div>
					<div class="col-1">
						&nbsp;
					</div>
					<div class="col-3">
						<button id="modalDefaultsBtn" type="button" class="btn btn-danger">Werkseinstellungen</button>
					</div>
				</div>
			</form>

			<br>

			<!-- modal set-defaults-confirmation window -->
			<div class="modal fade" id="setDefaultsConfirmationModal" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<!-- modal header -->
						<div class="modal-header bg-danger">
							<h4 class="modal-title text-light">Achtung</h4>
						</div>
						<!-- modal body -->
						<div class="modal-body text-center">
							<p>
								Sollen für den Lademodus Sofortladen wirklich die Werkseinstellungen eingestellt werden?
							</p>
						</div>
						<!-- modal footer -->
						<div class="modal-footer d-flex justify-content-center">
							<button type="button" class="btn btn-success" data-dismiss="modal" id="saveDefaultsBtn">Fortfahren</button>
							<button type="button" class="btn btn-danger" data-dismiss="modal">Abbruch</button>
						</div>
					</div>
				</div>
			</div>

			<!-- modal set-defaults-confirmation window -->
			<div class="modal fade" id="formNotValidModal" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<!-- modal header -->
						<div class="modal-header bg-danger">
							<h4 class="modal-title text-light">Fehler</h4>
						</div>
						<!-- modal body -->
						<div class="modal-body text-center">
							<p>
								Es wurden fehlerhafte Eingaben gefunden, speichern ist nicht möglich! Bitte überprüfen Sie alle Eingaben.
							</p>
						</div>
						<!-- modal footer -->
						<div class="modal-footer d-flex justify-content-center">
							<button type="button" class="btn btn-primary" data-dismiss="modal">Schließen</button>
						</div>
					</div>
				</div>
			</div>

		</div>  <!-- container -->

		<footer class="footer bg-dark text-light font-small">
			<div class="container text-center">
				<small>Sie befinden sich hier: Ladeeinstellungen/Sofortladen</small>
			</div>
		</footer>

		<!-- load mqtt library -->
		<script src = "js/mqttws31.js" ></script>
		<!-- load topics -->
		<script src = "settings/topicsToSubscribe_sofortconfig.js?ver=20200428-a" ></script>
		<!-- load helper functions -->
		<script src = "settings/helperFunctions.js?ver=20200427-a" ></script>
		<!-- load service -->
		<script src = "settings/setupMqttServices.js?ver=20200424-a" ></script>
		<!-- load mqtt handler-->
		<script src = "settings/processAllMqttMsg_sofortconfig.js?ver=20200428-a" ></script>

		<script type="text/javascript">

			$.get('settings/navbar.html', function(data){
				$('#nav').replaceWith(data);
				// disable navbar entry for current page
				$('#navSofortLadeeinstellungen').addClass('disabled');
			});

			function saveSettings() {
				// sends all changed values by mqtt if valid
				var formValid = $("#myForm")[0].checkValidity();
				if ( !formValid ) {
					$('#formNotValidModal').modal();
					return;
				}
				sendValues(getChangedValues());
				setTimeout(function(){ window.location.href = './index.php'; }, 100);
			}

			$(document).ready(function(){

				$('input').blur(function(event) {
					// check input field on blur if value is valid
					if ( event.target.checkValidity() == false ) {
						$(this).addClass('is-invalid');
					} else {
						$(this).removeClass('is-invalid');
					}
				});

				$('#saveSettingsBtn').on("click",function() {
					saveSettings();
				});

				$('#modalDefaultsBtn').on("click",function() {
					$('#setDefaultsConfirmationModal').modal();
				});

				$('#saveDefaultsBtn').on("click",function() {
					// shown in confirmation modal
					// resets all values to defaults and sends all changed values by mqtt
					setToDefaults();
					sendValues(getChangedValues());
					setTimeout(function(){ window.location.href = './index.php'; }, 100);
				});

				$('input').on("paste",function(e) {
					// prevent paste to input fields to avoid garbage
					e.preventDefault();
				});

				$('.rangeInput').on('input', function() {
					// show slider value in label of class valueLabel
					updateLabel($(this).attr('id'));
				});

				$('input.naturalNumber').on('input', function() {
					// on the fly input validation
					formatToNaturalNumber(this);
				});
			});  // end document ready function

		</script>

	</body>
</html>
